# MCP Python Executor

A Model Context Protocol (MCP) server for executing Python code and managing Python packages. Now with multi-environment support!

## Features

- Execute Python code with safety constraints
- Install and manage Python packages
- Pre-configure commonly used packages
- Multiple virtual environment support
- Resource monitoring and limits
- Health checks and metrics
- Structured logging
- Secure command execution

## Virtual Environment Support

All tools in the MCP Python Executor support an optional `venvName` parameter to specify which virtual environment to use. If no environment is specified, the server uses the configured default environment.

Key virtual environment features:
- Secure name validation to prevent path traversal attacks
- Isolation between environments for packages and dependencies
- Concurrent operations on different environments
- Detailed metadata for each environment
- Command execution within the context of specific environments
- Consistent fallback to default environment

## Configuration

The server can be configured through environment variables in the MCP settings:

```json
{
  "mcpServers": {
    "mcp-python-executor": {
      "command": "node",
      "args": ["path/to/python-executor/build/index.js"],
      "env": {
        "PREINSTALLED_PACKAGES": "numpy pandas matplotlib scikit-learn",
        "MAX_MEMORY_MB": "512",
        "EXECUTION_TIMEOUT_MS": "30000",
        "MAX_CONCURRENT_EXECUTIONS": "5",
        "LOG_LEVEL": "info",
        "LOG_FORMAT": "json",
        "VENVS_BASE_PATH": "/path/to/venvs/directory",
        "DEFAULT_VENV_NAME": "default"
      }
    }
  }
}
```

### Environment Variables

- `PREINSTALLED_PACKAGES`: Space-separated list of Python packages to install on startup
- `MAX_MEMORY_MB`: Maximum memory limit per execution (default: 512)
- `EXECUTION_TIMEOUT_MS`: Maximum execution time in milliseconds (default: 30000)
- `MAX_CONCURRENT_EXECUTIONS`: Maximum number of concurrent executions (default: 5)
- `LOG_LEVEL`: Logging level (debug|info|error, default: info)
- `LOG_FORMAT`: Log format (json|text, default: json)
- `VENVS_BASE_PATH`: Base directory for storing virtual environments (default: ~/.mcp-python-venvs)
- `DEFAULT_VENV_NAME`: Name of the default virtual environment (default: "default")

## Available Tools

### 1. execute_python

Execute Python code and return the results.

```typescript
interface ExecutePythonArgs {
  code?: string;          // Python code to execute (inline)
  scriptPath?: string;    // Path to existing Python script file (alternative to code)
  inputData?: string[];   // Optional input data
  venvName?: string;      // Optional virtual environment name
}
```

Examples:

```javascript
// Example with inline code using default environment
{
  "code": "print('Hello, World!!')\nfor i in range(3): print(i)",
  "inputData": ["optional", "input", "data"]
}

// Example with script path using specific environment
{
  "scriptPath": "/path/to/your_script.py",
  "inputData": ["optional", "input", "data"],
  "venvName": "data-science-env"
}
```

### 2. install_packages

Install Python packages.

```typescript
interface InstallPackagesArgs {
  packages: string[] | string;  // Array of packages or comma-separated string
  venvName?: string;            // Optional virtual environment name
}
```

Example:

```javascript
// Install packages in default environment
{
  "packages": ["numpy", "pandas", "matplotlib"]
}

// Install packages in specific environment
{
  "packages": "tensorflow==2.12.0,keras",
  "venvName": "machine-learning"
}
```

### 3. uninstall_packages

Uninstall Python packages.

```typescript
interface UninstallPackagesArgs {
  packages: string[] | string;  // Array of packages or comma-separated string
  venvName?: string;            // Optional virtual environment name
}
```

Example:

```javascript
// Uninstall packages from default environment
{
  "packages": ["unused-package1", "unused-package2"]
}

// Uninstall packages from specific environment
{
  "packages": "tensorflow,keras",
  "venvName": "machine-learning"
}
```

### 4. list_packages

List installed packages.

```typescript
interface ListPackagesArgs {
  venvName?: string;  // Optional virtual environment name
}
```

Example:

```javascript
// List packages in specific environment
{
  "venvName": "data-science-env"
}

// List packages in default environment
{}
```

### 5. list_venvs

List all available virtual environments.

```typescript
interface ListVenvsArgs {
  // No parameters required
}
```

### 6. create_venv

Create a new virtual environment.

```typescript
interface CreateVenvArgs {
  venvName: string;      // Name for the new virtual environment
  description?: string;  // Optional description
}
```

Example:

```javascript
{
  "venvName": "machine-learning",
  "description": "Environment for ML projects with TensorFlow"
}
```

### 7. delete_venv

Delete a virtual environment.

```typescript
interface DeleteVenvArgs {
  venvName: string;    // Name of the virtual environment to delete
  confirm?: boolean;   // Required to delete the default environment
}
```

Example:

```javascript
{
  "venvName": "obsolete-env"
}
```

### 8. set_venv_description

Update the description for a virtual environment.

```typescript
interface SetVenvDescriptionArgs {
  venvName: string;     // Name of the virtual environment
  description: string;  // New description
}
```

Example:

```javascript
{
  "venvName": "data-science-env",
  "description": "Environment for data science with pandas and scikit-learn"
}
```

### 9. health_check

Check health of the server and virtual environments.

```typescript
interface HealthCheckArgs {
  venvName?: string;  // Optional virtual environment to check specifically
}
```

Example:

```javascript
// Check health of a specific environment
{
  "venvName": "data-science-env"
}

// Check overall server health
{}
```

## Security Considerations

- The server employs strict validation on virtual environment names to prevent path traversal attacks
- Command execution uses array-based arguments with spawn where possible to prevent command injection
- Each virtual environment has its own locking mechanism to prevent race conditions during concurrent operations
- The VenvManager class acts as a secure gateway for all virtual environment operations
- Python version verification uses the environment's Python executable, not the system Python
