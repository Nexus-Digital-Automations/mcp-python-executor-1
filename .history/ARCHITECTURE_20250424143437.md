# MCP Python Executor - Architecture

## Overview

The MCP Python Executor is designed as a secure environment for executing Python code and managing Python packages through a Model Context Protocol (MCP) server interface. The system uses virtual environments to provide isolation and supports multiple named environments to accommodate different package requirements.

## Core Components

### 1. Server Layer

The main server component (`PythonExecutorServer` class) handles:
- MCP API endpoints and request routing
- Tool handler implementation
- Error handling and response formatting

### 2. Virtual Environment Management

The `VenvManager` class provides an abstraction for managing multiple Python virtual environments:
- Secure path handling and validation
- Creation and deletion of environments
- Metadata management
- Concurrency locking
- Package management
- Command execution within virtual environments

The `VenvManager` is now properly integrated with all tool handlers, providing consistent virtual environment handling across the entire server:
- Each tool that interacts with Python uses the VenvManager to access the correct virtual environment
- The VenvManager is responsible for validating environment names, checking existence, and providing activation details
- Tools consistently default to the configured default environment when no specific environment is specified

### 3. Command Execution

Secure command execution is implemented using two approaches:
- Array-based spawning (preferred for security)
- Legacy string-based execution (for Windows activation scripts)

### 4. Configuration

The system is configured through environment variables and has sensible defaults:
- Base directory for virtual environments (`venvsBasePath`)
- Default virtual environment name (`defaultVenvName`)
- Execution timeouts
- Logging settings

## Security Aspects

1. **Path Validation**: All virtual environment names are validated through `validateVenvName()` to prevent directory traversal attacks.

2. **Command Injection Prevention**: Commands are executed using array-based arguments for spawn where possible to prevent command injection.

3. **Concurrency Protection**: A lock system prevents multiple operations from running simultaneously on the same virtual environment.

4. **Resource Limitations**: Execution timeouts and process monitoring prevent runaway scripts.

## Data Flow Architecture

```
Client Request → MCP Server → Tool Handler → VenvManager → Command Execution → Response
```

## Component Diagram

```
┌─────────────────┐     ┌──────────────────┐     ┌────────────────────┐
│                 │     │                  │     │                    │
│   MCP Server    │────▶│  Tool Handlers   │────▶│    VenvManager     │
│                 │     │                  │     │                    │
└─────────────────┘     └──────────────────┘     └────────────────────┘
                                │                          │
                                ▼                          ▼
                        ┌──────────────────┐     ┌────────────────────┐
                        │                  │     │                    │
                        │ Command Execution│     │  File System Ops   │
                        │                  │     │                    │
                        └──────────────────┘     └────────────────────┘
```

## Key Classes

1. **PythonExecutorServer**: The main server class that implements the MCP interface.

2. **VenvManager**: Manages virtual environments with secure path handling and concurrency control. 
   - Creates and deletes virtual environments
   - Validates environment names
   - Provides secure access to environment paths and executables
   - Ensures all operations on the same environment are properly sequenced

3. **Logger**: Custom logging implementation with structured output.

4. **ExecutorError**: Custom error class for standardized error reporting.

## Multi-Environment Architecture

The system supports multiple named virtual environments through:

1. **Configuration**: The `venvsBasePath` config parameter defines the base directory for all environments.

2. **Default Environment**: A `defaultVenvName` configuration defines the default environment when none is specified.

3. **Environment Isolation**: Each virtual environment has its own Python executable, packages, and site-packages directory.

4. **Environment-Specific Tools**: All tools accept an optional `venvName` parameter to specify which environment to use.

5. **Environment Metadata**: A metadata file stores information about each environment, such as descriptions and creation dates.

## Concurrency Model

1. **Environment-Level Locking**: Each virtual environment has a separate lock to allow concurrent operations on different environments.

2. **Promise-Based Queue**: Operations on the same environment are queued using a promise chain to ensure they execute in sequence.

3. **Active Execution Tracking**: The server tracks active Python executions to prevent resource exhaustion.

## Tool Handler Implementation

All tool handlers in the PythonExecutorServer class now follow a consistent pattern for virtual environment handling:

1. **Parameter Extraction**: Extract the optional `venvName` parameter from the request
2. **Target Determination**: Determine the target environment, defaulting to the configured default environment
3. **Environment Setup**: Ensure the target environment exists and is properly configured
4. **Activation Details**: Obtain activation details for the target environment from the VenvManager
5. **Command Execution**: Execute commands within the context of the target environment
6. **Result Handling**: Return results with proper error handling and environment context

## Future Architecture Improvements

1. **Containerization**: Isolate Python execution in ephemeral containers for improved security.

2. **Worker Pool**: Implement a worker pool to better manage resource allocation for concurrent executions.

3. **Caching Layer**: Add caching for package dependency resolution and virtual environment state.

4. **Resource Monitoring**: Implement real-time monitoring of CPU, memory, and disk usage for executions.

5. **Advanced Authentication**: Add fine-grained access control for virtual environment operations. 